<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Code Wall - Gioco di Codice</title>
<style>
  body {
    font-family: monospace, monospace;
    background: #1e1e1e;
    color: #eee;
    margin: 0; padding: 1rem;
    display: flex; flex-direction: column; align-items: center;
  }
  #game-container {
    max-width: 800px;
    width: 100%;
  }
  pre {
    background: #2d2d2d;
    padding: 1rem;
    border-radius: 6px;
    white-space: pre-wrap;
    word-break: break-word;
  }
  input.code-input {
    background: #444;
    border: none;
    border-radius: 4px;
    color: #eee;
    font-family: monospace;
    font-size: 1rem;
    padding: 0 4px;
    width: auto;
    min-width: 40px;
    margin: 0 2px;
    text-align: center;
  }
  button {
    background: #007acc;
    border: none;
    padding: 0.6rem 1.2rem;
    color: white;
    font-weight: bold;
    margin-top: 1rem;
    border-radius: 6px;
    cursor: pointer;
  }
  button:disabled {
    background: #555;
    cursor: not-allowed;
  }
  #score {
    font-weight: bold;
    margin-bottom: 1rem;
  }
  #message {
    margin-top: 1rem;
    font-size: 1.1rem;
  }
  @media(max-width:600px){
    pre {
      font-size: 0.85rem;
    }
  }
</style>
</head>
<body>

<div id="game-container">
  <div id="score">Punteggio: 0</div>
  <div id="code-area">
    <!-- codice con input da completare qui -->
  </div>
  <button id="check-btn" disabled>Verifica</button>
  <div id="message"></div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
$(function(){
  // Configura qui la base URL della cartella GitHub (con i file snippet-1.txt ... snippet-N.txt)
  // Deve essere accessibile via fetch
  const GITHUB_BASE_URL = 'https://raw.githubusercontent.com/salvatorecapolupo/codewall/main/';

  let maxSnippets = 5; // Numero totale snippet nella directory (modifica se serve)
  let currentSnippetNum = 0;
  let currentCodeLines = [];
  let inputPositions = [];
  let score = 0;

  const $codeArea = $('#code-area');
  const $checkBtn = $('#check-btn');
  const $score = $('#score');
  const $message = $('#message');

  // Funzione per pescare un numero random snippet
  function getRandomSnippetNum(){
    return Math.floor(Math.random()*maxSnippets) + 1;
  }

  // Carica lo snippet da GitHub e processa
  function loadSnippet(num){
    currentSnippetNum = num;
    inputPositions = [];
    $message.text('');
    $checkBtn.prop('disabled', true);
    $codeArea.html('Caricamento snippet #' + num + '...');
    
    fetch(GITHUB_BASE_URL + `snippet-${num}.txt`)
      .then(res => {
        if(!res.ok) throw new Error('Impossibile caricare snippet');
        return res.text();
      })
      .then(text => {
        parseSnippet(text);
      })
      .catch(err => {
        $codeArea.html('Errore nel caricamento dello snippet.');
        console.error(err);
      });
  }

  // Funzione per processare il testo dello snippet
  // Sintassi semplice: usiamo {{?}} per indicare pezzi mancanti da compilare
  // Es: console.log("Hello, {{?}}");
  // Per ogni {{?}} mettiamo input box e memorizziamo la risposta corretta
  // Nel file snippet-N.txt, la linea deve contenere il codice completo e i pezzi mancanti sostituiti da {{?answer}}
  // esempio: console.log("Hello, {{?world}}");  -> input atteso: world

  function parseSnippet(text){
    currentCodeLines = text.split('\n');

    // Costruiamo l'html con input al posto di {{?answer}}
    let html = '';

    currentCodeLines.forEach((line,i)=>{
      // Cerca pezzi {{?answer}} multipli nella linea
      // Sostituisci con <input data-index="..."/>
      let processedLine = '';
      let lastIndex = 0;
      let regex = /\{\{\?([^}]+)\}\}/g;
      let match;
      while((match = regex.exec(line)) !== null){
        // Parte prima del match
        processedLine += escapeHtml(line.substring(lastIndex, match.index));
        // Crea input
        let answer = match[1].trim();
        let inputId = inputPositions.length;
        inputPositions.push(answer);
        processedLine += `<input type="text" class="code-input" data-index="${inputId}" autocomplete="off" spellcheck="false" />`;
        lastIndex = regex.lastIndex;
      }
      // Aggiungi resto della linea
      processedLine += escapeHtml(line.substring(lastIndex));
      html += processedLine + '\n';
    });

    $codeArea.html('<pre>' + html + '</pre>');

    // abilita pulsante solo se c'Ã¨ almeno un input
    $checkBtn.prop('disabled', inputPositions.length === 0);

    // Aggiungi listener per abilitare/disabilitare bottone in base input
    $('.code-input').on('input', function(){
      // Se tutti input hanno qualcosa, abilita bottone
      let allFilled = true;
      $('.code-input').each(function(){
        if($(this).val().trim() === ''){
          allFilled = false;
          return false;
        }
      });
      $checkBtn.prop('disabled', !allFilled);
    });
  }

  // Escape HTML per mostrare codice in modo sicuro
  function escapeHtml(text) {
    return text.replace(/[&<>"']/g, function(m) {
      switch (m) {
        case '&': return '&amp;';
        case '<': return '&lt;';
        case '>': return '&gt;';
        case '"': return '&quot;';
        case "'": return '&#39;';
        default: return m;
      }
    });
  }

  // Controlla se risposte corrette
  function checkAnswers(){
    let allCorrect = true;
    $('.code-input').each(function(){
      let idx = parseInt($(this).data('index'));
      let val = $(this).val().trim();
      if(val !== inputPositions[idx]){
        allCorrect = false;
        return false; // esci dal each
      }
    });
    return allCorrect;
  }

  // Passa al prossimo snippet
  function nextSnippet(){
    let nextNum = getRandomSnippetNum();
    loadSnippet(nextNum);
  }

  $checkBtn.click(function(){
    if(checkAnswers()){
      score += 10;
      $score.text('Punteggio: ' + score);
      $message.text('Corretto! Caricamento prossimo snippet...');
      setTimeout(() => {
        nextSnippet();
      }, 1500);
    } else {
      $message.text('Qualcosa non va, riprova.');
    }
  });

  // Inizio gioco
  nextSnippet();
});
</script>

</body>
</html>
